<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    {% if award %}Edit Grant/Award{% else %}Create New Grant/Award{% endif %}
  </title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='assets/GrandGuard.png') }}"
             alt="GrantGuard logo" class="logo-img" />
        <span class="brand-text">GrantGuard</span>
      </div>
      <nav class="menu">
        <a href="/dashboard">Dashboard</a>
        <a class="active" href="/awards/new">Generate Grants</a>
        <a href="/policies/university">Policies</a>
        <a href="/subawards">Subawards</a>
        <a href="/settings">Settings</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Log out</a>
      </nav>
    </aside>

    <main class="content">
      <h2>
        {% if award %}Edit Grant/Award{% else %}Create New Grant/Award{% endif %}
      </h2>

      <!-- MAIN FORM -->
      <form id="awardForm"
            method="POST"
            action="{% if award %}{{ url_for('award_edit', award_id=award.award_id) }}{% else %}{{ url_for('awards_create') }}{% endif %}"
            style="display:flex; flex-direction:column; gap:16px; width:100%;">

        <!-- BASIC INFO -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Basic Information</h3>

          <!-- Title -->
          <input type="text"
                 name="title"
                 placeholder="Title"
                 required
                 value="{{ award.title if award else '' }}">

          <div style="display:flex; gap:12px;">
            <!-- Funding agency -->
            <select name="sponsor_type" required
                    style="flex:1; padding:12px; border-radius:10px;
                           border:1px solid #ccc; background:#f1f3f4;">
              <option value="" disabled {% if not award %}selected{% endif %}>Funding Agency</option>
              <option value="NSF" {% if award and award.sponsor_type=='NSF' %}selected{% endif %}>NSF</option>
              <option value="NIH" {% if award and award.sponsor_type=='NIH' %}selected{% endif %}>NIH</option>
              <option value="others" {% if award and award.sponsor_type=='others' %}selected{% endif %}>others</option>
            </select>
          </div>

          <div style="display:flex; gap:12px;">
            <input type="text" name="department"
                   placeholder="Department (e.g., Computer Science)" style="flex:1;"
                   value="{{ award.department if award else '' }}">
            <input type="text" name="college"
                   placeholder="College (e.g., College of Engineering)" style="flex:1;"
                   value="{{ award.college if award else '' }}">
          </div>

          <div style="display:flex; gap:12px;">
            <input type="email" name="contact_email"
                   placeholder="Contact Email" style="flex:1;"
                   value="{{ award.contact_email if award else '' }}">
            <input type="number" name="amount" step="0.01"
                   placeholder="Total Amount (USD)" required style="flex:1;"
                   value="{{ award.amount if award else '' }}">
          </div>

          <div style="display:flex; gap:12px;">
            <label style="flex:1;">
              Start Date
              <input id="start_date"
                     type="date"
                     name="start_date"
                     required
                     style="width:100%; padding:10px; border-radius:10px;
                            border:1px solid #ccc; background:#f1f3f4;"
                     value="{{ award.start_date if award and award.start_date else '' }}">
            </label>
            <label style="flex:1;">
              End Date
              <input id="end_date"
                     type="date"
                     name="end_date"
                     required
                     style="width:100%; padding:10px; border-radius:10px;
                            border:1px solid #ccc; background:#f1f3f4;"
                     value="{{ award.end_date if award and award.end_date else '' }}">
            </label>
          </div>
        </div>

        <!-- RESEARCH DETAILS -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Research Details</h3>
          <textarea name="abstract" rows="4"
                    placeholder="Abstract / Description – short paragraph about research goals"
                    style="padding:12px; border-radius:10px; border:1px solid #ccc; background:#f1f3f4;">{{ award.abstract if award else '' }}</textarea>
          <input type="text" name="keywords"
                 placeholder="Keywords / Focus Area (e.g., AI, Climate Modeling)"
                 value="{{ award.keywords if award else '' }}">
          <input type="text" name="collaborators"
                 placeholder="Collaborators – optional list of co-PIs or research assistants"
                 value="{{ award.collaborators if award else '' }}">
        </div>

        <!-- PERSONNEL -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Personnel Expense Information</h3>
          <p style="font-weight:600; margin-top:4px;">Estimated Work Hours</p>

          <div style="overflow-x:auto;">
            <table class="budget-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Position</th>
                  <th>Hours for year(s)</th>
                  <th>Same for Each Year</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="personnel-rows">
                <!-- starter blank row; JS will reuse/clone and also overwrite when editing -->
                <tr class="person-row">
                  <td>
                    <input type="text"
                           class="person-name"
                           name="personnel_name[]"
                           placeholder="Name">
                  </td>
                  <td>
                    <select name="personnel_position[]"
                            class="person-position">
                      <option value="">Select position</option>
                      <option>PI</option>
                      <option>Co-PI</option>
                      <option>UI Professional Staff</option>
                      <option>Postdoc</option>
                      <option>GRA</option>
                      <option>Undergrad</option>
                      <option>Temp Help</option>
                    </select>
                  </td>
                  <td>
                    <div class="year-hours"></div>
                  </td>
                  <td style="text-align:center;">
                    <input type="checkbox"
                           class="person-same-year"
                           name="personnel_same_each_year[]">
                  </td>
                  <td style="text-align:center;">
                    <button type="button"
                            class="person-remove">✕</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" id="add-personnel" class="btn" style="margin-top:12px;">
            Add Personnel
          </button>
        </div>

        <!-- TRAVEL -->
        <div class="card travel-section" style="display:flex; flex-direction:column; gap:16px;">
          <h3>Travel Expenses Information</h3>

          <!-- DOMESTIC TRAVEL -->
          <h4>Domestic Travel</h4>
          <div id="domestic-travel-list" class="travel-list">
            <div class="travel-item">
              <div class="travel-row">
                <input type="text"
                       name="domestic_travel_name[]"
                       class="travel-name"
                       placeholder="Travel Name">
                <textarea name="domestic_travel_desc[]"
                          class="travel-desc"
                          placeholder="Description"></textarea>
                <select name="domestic_travel_year[]"
                        class="travel-year">
                  <option value="">Select Year</option>
                </select>
                <input type="date"
                       name="domestic_travel_depart[]"
                       class="travel-depart"
                       placeholder="Depart">
                <input type="date"
                       name="domestic_travel_arrive[]"
                       class="travel-arrive"
                       placeholder="Arrive">
                <button type="button"
                        class="travel-remove">✕</button>
              </div>
              <div class="travel-row">
                <input type="number"
                       name="domestic_travel_flight[]"
                       class="travel-flight"
                       placeholder="Flight $">
                <input type="number"
                       name="domestic_travel_taxi[]"
                       class="travel-taxi"
                       placeholder="Taxi/Uber $/day">
                <input type="number"
                       name="domestic_travel_food[]"
                       class="travel-food"
                       placeholder="Food & Lodge $/day">
                <input type="number"
                       name="domestic_travel_days[]"
                       class="travel-days"
                       placeholder="Days">
              </div>
            </div>
          </div>
          <button type="button" id="add-domestic-travel" class="btn">
            Add Domestic Travel
          </button>

          <!-- INTERNATIONAL TRAVEL -->
          <h4>International Travel</h4>
          <div id="international-travel-list" class="travel-list">
            <div class="travel-item">
              <div class="travel-row">
                <input type="text"
                       name="international_travel_name[]"
                       class="travel-name"
                       placeholder="Travel Name">
                <textarea name="international_travel_desc[]"
                          class="travel-desc"
                          placeholder="Description"></textarea>
                <select name="international_travel_year[]"
                        class="travel-year">
                  <option value="">Select Year</option>
                </select>
                <input type="date"
                       name="international_travel_depart[]"
                       class="travel-depart"
                       placeholder="Depart">
                <input type="date"
                       name="international_travel_arrive[]"
                       class="travel-arrive"
                       placeholder="Arrive">
                <button type="button"
                        class="travel-remove">✕</button>
              </div>
              <div class="travel-row">
                <input type="number"
                       name="international_travel_flight[]"
                       class="travel-flight"
                       placeholder="Flight $">
                <input type="number"
                       name="international_travel_taxi[]"
                       class="travel-taxi"
                       placeholder="Taxi/Uber $/day">
                <input type="number"
                       name="international_travel_food[]"
                       class="travel-food"
                       placeholder="Food & Lodge $/day">
                <input type="number"
                       name="international_travel_days[]"
                       class="travel-days"
                       placeholder="Days">
              </div>
            </div>
          </div>
          <button type="button" id="add-international-travel" class="btn">
            Add International Travel
          </button>
        </div>

        <!-- MATERIALS / SUPPLIES -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Materials and Supplies</h3>

          <div id="materials-list" class="materials-list">
            <div class="material-item"
                 style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
              <select name="material_category[]"
                      class="material-category mat-type"
                      style="min-width:220px; flex:1;">
                <option value="">Select Material or Supply</option>
                <option>Equipment &gt;5K</option>
                <option>Materials and Supplies</option>
                <option>Equipment &lt;5K</option>
                <option>Publication Costs</option>
                <option>Computer Services</option>
                <option>Software</option>
                <option>Facility Usage Fees</option>
                <option>Conference Registration</option>
                <option>Other</option>
                <option>Grad Student Tuition &amp; Health Insurance</option>
              </select>

              <input type="number"
                     name="material_cost[]"
                     class="mat-cost"
                     placeholder="Enter Cost"
                     style="flex:0.7; min-width:140px;">

              <textarea name="material_desc[]"
                        class="mat-desc"
                        placeholder="Enter Description"
                        style="flex:2; min-width:220px; min-height:40px;"></textarea>

              <select name="material_year[]"
                      class="travel-year mat-year"
                      style="flex:0.7; min-width:120px;">
                <option value="">Select Year</option>
              </select>

              <button type="button"
                      class="material-remove"
                      style="border:none; background:none; color:#d9534f;
                             font-size:18px; cursor:pointer;">
                ✕
              </button>
            </div>
          </div>

          <button type="button" id="add-material" class="btn" style="align-self:flex-start;">
            Add Material/Supply
          </button>
        </div>

        <!-- HIDDEN JSON FIELDS (what Flask actually reads) -->
        <input type="hidden" id="personnel_json" name="personnel_json"
               value='{{ award.personnel_json | tojson | safe if award and award.personnel_json else "[]" }}'>
        <input type="hidden" id="domestic_travel_json" name="domestic_travel_json"
               value='{{ award.domestic_travel_json | tojson | safe if award and award.domestic_travel_json else "[]" }}'>
        <input type="hidden" id="international_travel_json" name="international_travel_json"
               value='{{ award.international_travel_json | tojson | safe if award and award.international_travel_json else "[]" }}'>
        <input type="hidden" id="materials_json" name="materials_json"
               value='{{ award.materials_json | tojson | safe if award and award.materials_json else "[]" }}'>

        <!-- SUBMIT -->
        <div>
          <button type="submit" class="btn">
            {% if award %}Save Changes{% else %}Create{% endif %}
          </button>
        </div>
      </form>

      <!-- Make initial JSON data available to JS when editing -->
      <script>
        window.INIT_PERSONNEL = {{ award.personnel_json | tojson | safe if award and award.personnel_json else '[]' }};
        window.INIT_DOM_TRAVEL = {{ award.domestic_travel_json | tojson | safe if award and award.domestic_travel_json else '[]' }};
        window.INIT_INTL_TRAVEL = {{ award.international_travel_json | tojson | safe if award and award.international_travel_json else '[]' }};
        window.INIT_MATERIALS = {{ award.materials_json | tojson | safe if award and award.materials_json else '[]' }};
      </script>

      <!-- JS for dynamic rows + JSON generation -->
      <script src="{{ url_for('static', filename='grant_form.js') }}"></script>
    </main>
  </div>
  <script src="{{ url_for('static', filename='theme.js') }}"></script>
</body>
</html>
