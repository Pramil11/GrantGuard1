<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    {% if award %}Edit Grant/Award{% else %}Create New Grant/Award{% endif %}
  </title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='assets/GrandGuard.png') }}"
             alt="GrantGuard logo" class="logo-img" />
        <span class="brand-text">GrantGuard</span>
      </div>
      <nav class="menu">
        <a href="/dashboard">Dashboard</a>
        <a class="active" href="/awards/new">Generate Grants</a>
        <a href="/policies/university">Policies</a>
        <a href="/subawards">Subawards</a>
        <a href="/settings">Settings</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Log out</a>
      </nav>
    </aside>

    <main class="content">
      <h2>
        {% if award %}Edit Grant/Award{% else %}Create New Grant/Award{% endif %}
      </h2>

      <!-- MAIN FORM -->
      <form id="awardForm"
            method="POST"
            action="{% if award %}{{ url_for('award_edit', award_id=award.award_id) }}{% else %}{{ url_for('awards_create') }}{% endif %}"
            style="display:flex; flex-direction:column; gap:16px; width:100%;">

        <!-- BASIC INFO -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Basic Information</h3>

          <!-- Title -->
          <input type="text"
                 name="title"
                 placeholder="Title"
                 required
                 value="{{ award.title if award else '' }}">

          <div style="display:flex; gap:12px;">
            <!-- Funding agency -->
            <select name="sponsor_type" required
                    style="flex:1; padding:12px; border-radius:10px;
                           border:1px solid #ccc;">
              <option value="" disabled {% if not award %}selected{% endif %}>Select Funding Agency *</option>
              <option value="NSF" {% if award and award.sponsor_type=='NSF' %}selected{% endif %}>NSF (National Science Foundation)</option>
              <option value="NIH" {% if award and award.sponsor_type=='NIH' %}selected{% endif %}>NIH (National Institutes of Health)</option>
            </select>
          </div>

          <div style="display:flex; gap:12px;">
            <input type="text" name="department"
                   placeholder="Department (e.g., Computer Science)" style="flex:1;"
                   value="{{ award.department if award else '' }}">
            <input type="text" name="college"
                   placeholder="College (e.g., College of Engineering)" style="flex:1;"
                   value="{{ award.college if award else '' }}">
          </div>

          <div style="display:flex; gap:12px;">
            <input type="email" name="contact_email"
                   placeholder="Contact Email" style="flex:1;"
                   value="{{ award.contact_email if award else '' }}">
            <input type="number" name="amount" step="0.01"
                   placeholder="Total Amount (USD)" required style="flex:1;"
                   value="{{ award.amount if award else '' }}">
          </div>

          <div style="display:flex; gap:12px;">
            <label style="flex:1;">
              Start Date
              <input id="start_date"
                     type="date"
                     name="start_date"
                     required
                     style="width:100%; padding:10px; border-radius:10px;
                            border:1px solid #ccc;"
                     value="{{ award.start_date if award and award.start_date else '' }}">
            </label>
            <label style="flex:1;">
              End Date
              <input id="end_date"
                     type="date"
                     name="end_date"
                     required
                     style="width:100%; padding:10px; border-radius:10px;
                            border:1px solid #ccc;"
                     value="{{ award.end_date if award and award.end_date else '' }}">
            </label>
          </div>
        </div>

        <!-- RESEARCH DETAILS -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Research Details</h3>
          <textarea name="abstract" rows="4"
                    placeholder="Abstract / Description – short paragraph about research goals"
                    style="padding:12px; border-radius:10px; border:1px solid #ccc;">{{ award.abstract if award else '' }}</textarea>
          <input type="text" name="keywords"
                 placeholder="Keywords / Focus Area (e.g., AI, Climate Modeling)"
                 value="{{ award.keywords if award else '' }}">
          <input type="text" name="collaborators"
                 placeholder="Collaborators – optional list of co-PIs or research assistants"
                 value="{{ award.collaborators if award else '' }}">
        </div>

        <!-- PERSONNEL -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Personnel Expense Information</h3>
          <p style="font-weight:600; margin-top:4px;">Estimated Work Hours</p>

          <div style="overflow-x:auto;">
            <table class="budget-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Position</th>
                  <th>Hours for year(s)</th>
                  <th>Same for Each Year</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="personnel-rows">
                <!-- starter blank row; JS will reuse/clone and also overwrite when editing -->
                <tr class="person-row">
                  <td>
                    <input type="text"
                           class="person-name"
                           name="personnel_name[]"
                           placeholder="Name">
                  </td>
                  <td>
                    <select name="personnel_position[]"
                            class="person-position">
                      <option value="">Select Position *</option>
                      <option>PI (Principal Investigator)</option>
                      <option>Co-PI (Co-Principal Investigator)</option>
                      <option>Postdoctoral Researcher</option>
                      <option>Graduate Research Assistant (GRA)</option>
                      <option>Graduate Student</option>
                      <option>Undergraduate Student</option>
                      <option>Research Technician</option>
                      <option>Research Scientist</option>
                      <option>Professional Staff (100% Project Dedicated)</option>
                      <option>Other Research Personnel</option>
                    </select>
                  </td>
                  <td>
                    <div class="year-hours"></div>
                  </td>
                  <td style="text-align:center;">
                    <input type="checkbox"
                           class="person-same-year"
                           name="personnel_same_each_year[]">
                  </td>
                  <td style="text-align:center;">
                    <button type="button"
                            class="person-remove">✕</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" id="add-personnel" class="btn" style="margin-top:12px;">
            Add Personnel
          </button>
        </div>

        <!-- TRAVEL -->
        <div class="card travel-section" style="display:flex; flex-direction:column; gap:16px;">
          <h3>Travel Expenses</h3>
          <p style="font-size:0.875em; color:#6b7280; margin-top:-8px;">Only economy class travel allowed. Must be directly related to research (conferences, collaboration, data collection).</p>

          <!-- DOMESTIC TRAVEL -->
          <h4>Domestic Travel</h4>
          <div id="domestic-travel-list" class="travel-list">
            <div class="travel-item">
              <div class="travel-row">
                <textarea name="domestic_travel_desc[]"
                          class="travel-desc"
                          placeholder="Description & Research Purpose *"
                          required></textarea>
              </div>
              <div class="travel-row">
                <input type="number"
                       name="domestic_travel_flight[]"
                       class="travel-flight"
                       placeholder="Flight $">
                <input type="number"
                       name="domestic_travel_taxi[]"
                       class="travel-taxi"
                       placeholder="Taxi/Uber $/day">
                <input type="number"
                       name="domestic_travel_food[]"
                       class="travel-food"
                       placeholder="Food & Lodge $/day">
              </div>
            </div>
          </div>
          <button type="button" id="add-domestic-travel" class="btn">
            Add Domestic Travel
          </button>

          <!-- INTERNATIONAL TRAVEL -->
          <h4>International Travel</h4>
          <div id="international-travel-list" class="travel-list">
            <div class="travel-item">
              <div class="travel-row">
                <textarea name="international_travel_desc[]"
                          class="travel-desc"
                          placeholder="Description & Research Purpose *"
                          required></textarea>
              </div>
              <div class="travel-row">
                <input type="number"
                       name="international_travel_flight[]"
                       class="travel-flight"
                       placeholder="Flight $">
                <input type="number"
                       name="international_travel_taxi[]"
                       class="travel-taxi"
                       placeholder="Taxi/Uber $/day">
                <input type="number"
                       name="international_travel_food[]"
                       class="travel-food"
                       placeholder="Food & Lodge $/day">
              </div>
            </div>
          </div>
          <button type="button" id="add-international-travel" class="btn">
            Add International Travel
          </button>
        </div>

        <!-- EQUIPMENT -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Equipment</h3>
          <p style="font-size:0.875em; color:#6b7280; margin-top:-8px;">Equipment over $5,000 requires university approval per policy</p>

          <div id="equipment-list" class="materials-list">
            <div class="material-item"
                 style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
              <input type="number"
                     name="equipment_cost[]"
                     class="mat-cost"
                     placeholder="Cost ($)"
                     step="0.01"
                     min="0"
                     style="flex:0.7; min-width:140px;">

              <textarea name="equipment_desc[]"
                        class="mat-desc"
                        placeholder="Equipment Description & Justification *"
                        required
                        style="flex:2; min-width:220px; min-height:40px;"></textarea>
              <button type="button"
                      class="material-remove"
                      style="border:none; background:none; color:#d9534f;
                             font-size:18px; cursor:pointer;">
                ✕
              </button>
            </div>
          </div>

          <button type="button" id="add-equipment" class="btn" style="align-self:flex-start;">
            Add Equipment
          </button>
        </div>

        <!-- MATERIALS / SUPPLIES -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Materials and Supplies</h3>
          <p style="font-size:0.875em; color:#6b7280; margin-top:-8px;">Lab consumables, chemicals, computing accessories, and research supplies</p>

          <div id="materials-list" class="materials-list">
            <div class="material-item"
                 style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
              <input type="number"
                     name="material_cost[]"
                     class="mat-cost"
                     placeholder="Cost ($)"
                     step="0.01"
                     min="0"
                     style="flex:0.7; min-width:140px;">

              <textarea name="material_desc[]"
                        class="mat-desc"
                        placeholder="Description & Justification *"
                        required
                        style="flex:2; min-width:220px; min-height:40px;"></textarea>
              <button type="button"
                      class="material-remove"
                      style="border:none; background:none; color:#d9534f;
                             font-size:18px; cursor:pointer;">
                ✕
              </button>
            </div>
          </div>

          <button type="button" id="add-material" class="btn" style="align-self:flex-start;">
            Add Material/Supply
          </button>
        </div>

        <!-- OTHER DIRECT COSTS -->
        <div class="card" style="display:flex; flex-direction:column; gap:12px;">
          <h3>Other Direct Costs</h3>
          <p style="font-size:0.875em; color:#6b7280; margin-top:-8px;">Publication fees, software licenses, facility fees, conference registration, and other research-related costs</p>

          <div id="other-costs-list" class="materials-list">
            <div class="material-item"
                 style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
              <input type="number"
                     name="other_cost_amount[]"
                     class="mat-cost"
                     placeholder="Cost ($)"
                     step="0.01"
                     min="0"
                     style="flex:0.7; min-width:140px;">

              <textarea name="other_cost_desc[]"
                        class="mat-desc"
                        placeholder="Description & Justification *"
                        required
                        style="flex:2; min-width:220px; min-height:40px;"></textarea>
              <button type="button"
                      class="material-remove"
                      style="border:none; background:none; color:#d9534f;
                             font-size:18px; cursor:pointer;">
                ✕
              </button>
            </div>
          </div>

          <button type="button" id="add-other-cost" class="btn" style="align-self:flex-start;">
            Add Other Direct Cost
          </button>
        </div>

        <!-- HIDDEN JSON FIELDS (what Flask actually reads) -->
        <input type="hidden" id="personnel_json" name="personnel_json"
               value='{{ award.personnel_json | tojson | safe if award and award.personnel_json else "[]" }}'>
        <input type="hidden" id="domestic_travel_json" name="domestic_travel_json"
               value='{{ award.domestic_travel_json | tojson | safe if award and award.domestic_travel_json else "[]" }}'>
        <input type="hidden" id="international_travel_json" name="international_travel_json"
               value='{{ award.international_travel_json | tojson | safe if award and award.international_travel_json else "[]" }}'>
        <input type="hidden" id="materials_json" name="materials_json"
               value='{{ award.materials_json | tojson | safe if award and award.materials_json else "[]" }}'>
        <input type="hidden" id="equipment_json" name="equipment_json"
               value='{{ award.equipment_json | tojson | safe if award and award.equipment_json else "[]" }}'>
        <input type="hidden" id="other_costs_json" name="other_costs_json"
               value='{{ award.other_costs_json | tojson | safe if award and award.other_costs_json else "[]" }}'>

        <!-- SUBMIT -->
        <div>
          <button type="submit" class="btn">
            {% if award %}Save Changes{% else %}Create{% endif %}
          </button>
        </div>
      </form>

      <!-- Make initial JSON data available to JS when editing -->
      <script>
        window.INIT_PERSONNEL = {{ award.personnel_json | tojson | safe if award and award.personnel_json else '[]' }};
        window.INIT_DOM_TRAVEL = {{ award.domestic_travel_json | tojson | safe if award and award.domestic_travel_json else '[]' }};
        window.INIT_INTL_TRAVEL = {{ award.international_travel_json | tojson | safe if award and award.international_travel_json else '[]' }};
        window.INIT_MATERIALS = {{ award.materials_json | tojson | safe if award and award.materials_json else '[]' }};
        window.INIT_EQUIPMENT = {{ award.equipment_json | tojson | safe if award and award.equipment_json else '[]' }};
        window.INIT_OTHER_COSTS = {{ award.other_costs_json | tojson | safe if award and award.other_costs_json else '[]' }};
      </script>

      <!-- JS for dynamic rows + JSON generation -->
      <script src="{{ url_for('static', filename='grant_form.js') }}"></script>
    </main>
  </div>
  <script src="{{ url_for('static', filename='theme.js') }}"></script>
</body>
</html>
