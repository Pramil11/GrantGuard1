<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Transaction - GrantGuard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='assets/GrandGuard.png') }}" alt="GrantGuard logo" class="logo-img" />
        <span class="brand-text">GrantGuard</span>
      </div>
      <nav class="menu">
        <a href="/dashboard">Dashboard</a>
        {% if user.role != 'Admin' %}
        <a href="/awards/new">Generate Grants</a>
        {% endif %}
        <a href="/policies/university">Policies</a>
        <a href="/subawards">Subawards</a>
        <a href="/settings">Settings</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Log out</a>
      </nav>
    </aside>
    <main class="content">
      <header style="margin-bottom: 24px;">
        <a class="back-link" href="{{ url_for('award_view', award_id=award.award_id) }}">← Back to Award</a>
        <h1 style="margin: 8px 0 0 0; font-size: 1.75em; font-weight: 700; color: var(--gg-text-main);">New Spending Request</h1>
        <p style="margin: 8px 0 0 0; font-size: 0.875em; color: #6b7280;">Award: {{ award.title }}</p>
      </header>

      <div class="card" style="margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 1.125em; font-weight: 600; color: var(--gg-text-main);">Budget Overview</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          {% for category, budget in budget_status.items() %}
          <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
            <div style="font-size: 0.8125em; color: #6b7280; margin-bottom: 4px;">{{ category }}</div>
            <div style="font-size: 0.875em; font-weight: 600; color: var(--gg-text-main);">
              Remaining: ${{ '{:,.2f}'.format(budget.remaining) }}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      {% if error %}
      <div class="card" style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 24px;">
        <div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">Error</div>
        <div style="color: #991b1b; font-size: 0.875em;">{{ error }}</div>
      </div>
      {% endif %}

      <form method="POST" action="{{ url_for('transaction_create') }}" class="card" style="display: flex; flex-direction: column; gap: 16px;" id="transaction-form">
        <input type="hidden" name="award_id" value="{{ award.award_id }}">

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Category *</label>
          <select name="category" id="category-select" required style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            <option value="">Select Category</option>
            <option value="Personnel">Personnel</option>
            <option value="Travel">Travel</option>
            <option value="Materials">Materials</option>
            <option value="Equipment">Equipment</option>
            <option value="Other Direct Costs">Other Direct Costs</option>
          </select>
        </div>

        <!-- Travel Detail Fields (shown only when Travel is selected) -->
        <div id="travel-details-section" style="display: none;">
          <h4 style="margin: 0 0 16px 0; font-size: 1em; font-weight: 600; color: var(--gg-text-main);">Travel Expense Breakdown</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Flight/Airfare</label>
              <input type="number" name="travel_flight" id="travel-flight" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Ground Transportation</label>
              <input type="number" name="travel_ground" id="travel-ground" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Lodging</label>
              <input type="number" name="travel_lodging" id="travel-lodging" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Meals</label>
              <input type="number" name="travel_meals" id="travel-meals" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Other Travel Expenses</label>
              <input type="number" name="travel_other" id="travel-other" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Total *</label>
              <input type="number" name="amount" id="amount-input-travel" step="0.01" min="0.01" required placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: #f3f4f6; color: var(--gg-text-main); font-size: 0.875em; font-weight: 600; cursor: not-allowed;" readonly>
            </div>
          </div>
          <div id="budget-warning-travel" style="display: none; margin-top: 8px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
            <div style="color: #92400e; font-weight: 600; font-size: 0.875em; margin-bottom: 4px;">⚠ Budget Warning</div>
            <div style="color: #78350f; font-size: 0.8125em;" id="warning-text-travel"></div>
          </div>
        </div>

        <!-- Standard Amount Field (shown for non-Travel categories) -->
        <div id="standard-amount-section">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Amount (USD) *</label>
          <input type="number" name="amount" id="amount-input-standard" step="0.01" min="0.01" required placeholder="0.00" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
          <div id="budget-warning" style="display: none; margin-top: 8px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
            <div style="color: #92400e; font-weight: 600; font-size: 0.875em; margin-bottom: 4px;">⚠ Budget Warning</div>
            <div style="color: #78350f; font-size: 0.8125em;" id="warning-text"></div>
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Date *</label>
          <input type="date" name="date_submitted" required style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--gg-text-main);">Description *</label>
          <textarea name="description" required rows="4" placeholder="Describe what this spending is for..." style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e3e7; background: var(--gg-bg-card); color: var(--gg-text-main); font-size: 0.875em; font-family: 'Poppins', sans-serif;"></textarea>
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn" style="flex: 1;">Submit Request</button>
          <a href="{{ url_for('award_view', award_id=award.award_id) }}" class="btn" style="flex: 1; text-align: center; background: #6b7280; text-decoration: none; display: flex; align-items: center; justify-content: center;">Cancel</a>
        </div>
      </form>
    </main>
  </div>
  <script src="{{ url_for('static', filename='theme.js') }}"></script>
  <script>
    // Budget status data for client-side validation
    const budgetStatus = {{ budget_status | tojson }};
    
    const categorySelect = document.getElementById('category-select');
    const travelDetailsSection = document.getElementById('travel-details-section');
    const standardAmountSection = document.getElementById('standard-amount-section');
    const amountInputTravel = document.getElementById('amount-input-travel');
    const amountInputStandard = document.getElementById('amount-input-standard');
    const budgetWarning = document.getElementById('budget-warning');
    const warningText = document.getElementById('warning-text');
    const budgetWarningTravel = document.getElementById('budget-warning-travel');
    const warningTextTravel = document.getElementById('warning-text-travel');
    
    // Travel expense inputs
    const travelFlight = document.getElementById('travel-flight');
    const travelGround = document.getElementById('travel-ground');
    const travelLodging = document.getElementById('travel-lodging');
    const travelMeals = document.getElementById('travel-meals');
    const travelOther = document.getElementById('travel-other');
    
    // Calculate travel total
    function calculateTravelTotal() {
      const flight = parseFloat(travelFlight.value) || 0;
      const ground = parseFloat(travelGround.value) || 0;
      const lodging = parseFloat(travelLodging.value) || 0;
      const meals = parseFloat(travelMeals.value) || 0;
      const other = parseFloat(travelOther.value) || 0;
      const total = flight + ground + lodging + meals + other;
      if (amountInputTravel) {
        if (total > 0) {
          amountInputTravel.value = total.toFixed(2);
        } else {
          amountInputTravel.value = '';
        }
      }
      checkBudget();
    }
    
    // Show/hide travel details based on category
    function toggleTravelFields() {
      const category = categorySelect.value;
      
      if (category === 'Travel') {
        travelDetailsSection.style.display = 'block';
        standardAmountSection.style.display = 'none';
        // Make travel amount required, standard not required
        if (amountInputTravel) {
          amountInputTravel.required = true;
          amountInputTravel.name = 'amount'; // Ensure it has the correct name
        }
        if (amountInputStandard) {
          amountInputStandard.required = false;
          amountInputStandard.removeAttribute('name'); // Remove name so it's not submitted
          amountInputStandard.value = ''; // Clear value
        }
      } else {
        travelDetailsSection.style.display = 'none';
        standardAmountSection.style.display = 'block';
        // Make standard amount required, travel not required
        if (amountInputStandard) {
          amountInputStandard.required = true;
          amountInputStandard.name = 'amount'; // Ensure it has the correct name
        }
        if (amountInputTravel) {
          amountInputTravel.required = false;
          amountInputTravel.removeAttribute('name'); // Remove name so it's not submitted
          amountInputTravel.value = ''; // Clear value
        }
        // Clear travel fields
        if (travelFlight) travelFlight.value = '';
        if (travelGround) travelGround.value = '';
        if (travelLodging) travelLodging.value = '';
        if (travelMeals) travelMeals.value = '';
        if (travelOther) travelOther.value = '';
      }
      checkBudget();
    }
    
    function checkBudget() {
      const category = categorySelect.value;
      let amount = 0;
      let warningElement, textElement;
      
      if (category === 'Travel') {
        amount = parseFloat(amountInputTravel?.value) || 0;
        warningElement = budgetWarningTravel;
        textElement = warningTextTravel;
      } else {
        amount = parseFloat(amountInputStandard?.value) || 0;
        warningElement = budgetWarning;
        textElement = warningText;
      }
      
      if (!category || amount <= 0) {
        if (warningElement) warningElement.style.display = 'none';
        if (budgetWarning) budgetWarning.style.display = 'none';
        if (budgetWarningTravel) budgetWarningTravel.style.display = 'none';
        return;
      }
      
      // Map category names to match budget status keys
      let budgetKey = category;
      
      const categoryBudget = budgetStatus[budgetKey];
      
      if (!categoryBudget) {
        if (warningElement) warningElement.style.display = 'none';
        if (budgetWarning) budgetWarning.style.display = 'none';
        if (budgetWarningTravel) budgetWarningTravel.style.display = 'none';
        return;
      }
      
      const allocated = categoryBudget.allocated || 0;
      const remaining = categoryBudget.remaining || 0;
      
      if (allocated > 0 && amount > remaining) {
        if (warningElement) {
          warningElement.style.display = 'block';
          textElement.innerHTML = `
            This amount ($${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}) exceeds the remaining budget 
            ($${remaining.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}) for ${category}. 
            ${allocated > 0 ? `Total allocated: $${allocated.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}
          `;
          warningElement.style.background = '#fef2f2';
          warningElement.style.borderLeftColor = '#ef4444';
          textElement.style.color = '#991b1b';
        }
      } else if (allocated > 0 && amount > allocated * 0.9) {
        // Warn if approaching the allocated amount (90% threshold)
        if (warningElement) {
          warningElement.style.display = 'block';
          textElement.innerHTML = `
            This amount is approaching the allocated budget for ${category}. 
            Remaining: $${remaining.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
          `;
          warningElement.style.background = '#fef3c7';
          warningElement.style.borderLeftColor = '#f59e0b';
          textElement.style.color = '#78350f';
        }
      } else {
        if (warningElement) warningElement.style.display = 'none';
      }
    }
    
    // Event listeners
    categorySelect.addEventListener('change', toggleTravelFields);
    if (amountInputStandard) amountInputStandard.addEventListener('input', checkBudget);
    
    // Travel expense input listeners
    if (travelFlight) travelFlight.addEventListener('input', calculateTravelTotal);
    if (travelGround) travelGround.addEventListener('input', calculateTravelTotal);
    if (travelLodging) travelLodging.addEventListener('input', calculateTravelTotal);
    if (travelMeals) travelMeals.addEventListener('input', calculateTravelTotal);
    if (travelOther) travelOther.addEventListener('input', calculateTravelTotal);
    
    // Form submission handler to ensure correct amount field is used
    const form = document.getElementById('transaction-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const category = categorySelect.value;
        
        // Ensure the correct amount field is used based on category
        if (category === 'Travel') {
          // Recalculate total to ensure it's up to date
          calculateTravelTotal();
          
          const travelTotal = parseFloat(amountInputTravel?.value) || 0;
          if (travelTotal > 0) {
            // Travel amount is set, ensure it's the one submitted
            amountInputTravel.name = 'amount';
            if (amountInputStandard) {
              amountInputStandard.removeAttribute('name');
              amountInputStandard.required = false;
              amountInputStandard.value = ''; // Clear to avoid conflicts
            }
          } else {
            e.preventDefault();
            alert('Please enter at least one travel expense. The total must be greater than $0.00.');
            if (travelFlight) travelFlight.focus();
            return false;
          }
        } else {
          const standardAmount = parseFloat(amountInputStandard?.value) || 0;
          if (standardAmount > 0) {
            // Standard amount is set, ensure it's the one submitted
            amountInputStandard.name = 'amount';
            if (amountInputTravel) {
              amountInputTravel.removeAttribute('name');
              amountInputTravel.required = false;
              amountInputTravel.value = ''; // Clear to avoid conflicts
            }
          } else {
            e.preventDefault();
            alert('Please enter an amount greater than $0.00.');
            if (amountInputStandard) {
              amountInputStandard.focus();
            }
            return false;
          }
        }
      });
    }
    
    // Initialize on page load
    toggleTravelFields();
    if (amountInputStandard && amountInputStandard.value) {
      checkBudget();
    }
  </script>
</body>
</html>
