<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Grant - {{ award.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='assets/GrandGuard.png') }}"
             alt="GrantGuard logo" class="logo-img" />
        <span class="brand-text">GrantGuard</span>
      </div>
      <nav class="menu">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a class="active" href="{{ url_for('award_view', award_id=award.award_id) }}">View Grant</a>
        {% if user.role != 'Admin' %}
        <a href="{{ url_for('awards_new') }}">Generate Grants</a>
        {% endif %}
        <a href="{{ url_for('university_policies') }}">Policies</a>
        <a href="{{ url_for('subawards') }}">Subawards</a>
        <a href="{{ url_for('settings') }}">Settings</a>
        <a href="{{ url_for('profile') }}">Profile</a>
        <a href="{{ url_for('logout') }}">Log out</a>
      </nav>
    </aside>

    <main class="content">
      <!-- =======================
           Grant overview
      ======================== -->
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
        <div style="flex: 1;">
          <h2 style="margin: 0 0 8px 0;">{{ award.title }}</h2>
          <p style="margin: 0; color: #6b7280; font-size: 0.875em;">Status: <span style="font-weight: 600; color: var(--gg-text-main);">{{ award.status }}</span></p>
        </div>
        
        <!-- Admin Approve/Decline Buttons (Top Right) -->
        {% if user.role == 'Admin' and award.status == 'Pending' %}
        <div style="display: flex; gap: 12px; align-items: center;">
          <form method="post" action="{{ url_for('award_decline', award_id=award.award_id) }}" style="display:inline;">
            <button type="submit" class="btn" style="background: #ef4444; color: white;">
              Decline
            </button>
          </form>
          <form method="post" action="{{ url_for('award_approve', award_id=award.award_id) }}" style="display:inline;">
            <button type="submit" class="btn" style="background: #10b981; color: white;">
              Approve
            </button>
          </form>
        </div>
        {% endif %}
      </div>
      
      <!-- Action Buttons (moved to top for all users) -->
      <div style="margin-bottom:24px; display:flex; flex-wrap:wrap; gap:8px;">
        {% if award.status == 'Draft' %}
        <form method="post" action="{{ url_for('award_submit', award_id=award.award_id) }}" style="display:inline;">
          <button type="submit" class="btn" style="background: #10b981;">
            Submit Award
          </button>
        </form>
        {% endif %}
        <a href="{{ url_for('award_edit', award_id=award.award_id) }}" class="btn">
          Edit
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn">
          Back to Dashboard
        </a>
        <a href="{{ url_for('download_award_pdf', award_id=award.award_id) }}" class="btn btn-secondary">
          Download PDF
        </a>
        <a href="{{ url_for('download_award_excel', award_id=award.award_id) }}" class="btn btn-secondary">
          Download Excel
        </a>
        {% if user.role == 'Admin' and award.status == 'Pending' %}
        <button id="check-compliance-btn" class="btn" style="background: #8b5cf6;">
          <span id="check-compliance-text">Check AI Compliance</span>
          <span id="check-compliance-loading" style="display:none;">Checking...</span>
        </button>
        {% endif %}
        {% if award.status == 'Approved' %}
        <a href="{{ url_for('budget_status', award_id=award.award_id) }}" class="btn" style="background: #0b84f3;">
          Budget Status
        </a>
        <a href="{{ url_for('transactions_list', award_id=award.award_id) }}" class="btn" style="background: #6b7280;">
          Transactions
        </a>
        {% endif %}
      </div>
      
      <!-- AI Compliance Results Section (Admin only, for Pending awards) -->
      {% if user.role == 'Admin' and award.status == 'Pending' %}
      <div class="card" id="compliance-section" style="margin-top:24px; {% if not compliance_results %}display:none;{% endif %}">
        <h3 style="margin-top:0;">AI Policy Compliance Check</h3>
        {% if compliance_results and compliance_results.error %}
          <p style="color: #ef4444;">Error: {{ compliance_results.error }}</p>
        {% elif compliance_results %}
          <div style="display: grid; gap: 16px;">
            {% if compliance_results.university %}
            <div style="padding: 12px; border-radius: 8px; border-left: 4px solid {% if compliance_results.university.result == 'compliant' %}#10b981{% elif compliance_results.university.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %}; background: {% if compliance_results.university.result == 'compliant' %}#f0fdf4{% elif compliance_results.university.result == 'non-compliant' %}#fef2f2{% else %}#f9fafb{% endif %};">
              <strong>University Policy:</strong> 
              <span style="text-transform: capitalize; font-weight: 600; color: {% if compliance_results.university.result == 'compliant' %}#10b981{% elif compliance_results.university.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %};">
                {{ compliance_results.university.result }}
              </span>
              <p style="margin: 8px 0 0 0; color: #4b5563;">{{ compliance_results.university.reason }}</p>
            </div>
            {% endif %}
            
            {% if compliance_results.federal %}
            <div style="padding: 12px; border-radius: 8px; border-left: 4px solid {% if compliance_results.federal.result == 'compliant' %}#10b981{% elif compliance_results.federal.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %}; background: {% if compliance_results.federal.result == 'compliant' %}#f0fdf4{% elif compliance_results.federal.result == 'non-compliant' %}#fef2f2{% else %}#f9fafb{% endif %};">
              <strong>Federal Policy:</strong> 
              <span style="text-transform: capitalize; font-weight: 600; color: {% if compliance_results.federal.result == 'compliant' %}#10b981{% elif compliance_results.federal.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %};">
                {{ compliance_results.federal.result }}
              </span>
              <p style="margin: 8px 0 0 0; color: #4b5563;">{{ compliance_results.federal.reason }}</p>
            </div>
            {% endif %}
            
            {% if compliance_results.sponsor %}
            <div style="padding: 12px; border-radius: 8px; border-left: 4px solid {% if compliance_results.sponsor.result == 'compliant' %}#10b981{% elif compliance_results.sponsor.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %}; background: {% if compliance_results.sponsor.result == 'compliant' %}#f0fdf4{% elif compliance_results.sponsor.result == 'non-compliant' %}#fef2f2{% else %}#f9fafb{% endif %};">
              <strong>Sponsor Policy:</strong> 
              <span style="text-transform: capitalize; font-weight: 600; color: {% if compliance_results.sponsor.result == 'compliant' %}#10b981{% elif compliance_results.sponsor.result == 'non-compliant' %}#ef4444{% else %}#6b7280{% endif %};">
                {{ compliance_results.sponsor.result }}
              </span>
              <p style="margin: 8px 0 0 0; color: #4b5563;">{{ compliance_results.sponsor.reason }}</p>
            </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
      {% endif %}
      
      <div class="card">
        <p><strong>Funding Agency:</strong> {{ award.sponsor_type or 'N/A' }}</p>
        <p><strong>Amount:</strong> ${{ '%.2f'|format(award.amount or 0) }}</p>

        {% if award.start_date and award.end_date %}
          <p>
            <strong>Period:</strong>
            {{ award.start_date }} â†’ {{ award.end_date }}
            {% if duration_years %}
              ({{ duration_years }} year{{ 's' if duration_years != 1 else '' }})
            {% endif %}
          </p>
        {% else %}
          <p><strong>Start Date:</strong> {{ award.start_date or 'N/A' }}</p>
          <p><strong>End Date:</strong> {{ award.end_date or 'N/A' }}</p>
        {% endif %}

        <p><strong>Status:</strong> {{ award.status or 'Pending' }}</p>
        <p><strong>Department:</strong> {{ award.department or 'N/A' }}</p>
        <p><strong>College:</strong> {{ award.college or 'N/A' }}</p>
        <p><strong>Contact Email:</strong> {{ award.contact_email or 'N/A' }}</p>
        <p><strong>Abstract:</strong><br>
          {{ award.abstract or 'No abstract provided.' }}</p>
        <p><strong>Keywords:</strong> {{ award.keywords or 'N/A' }}</p>
        <p><strong>Collaborators:</strong> {{ award.collaborators or 'N/A' }}</p>
      </div>

      <!-- =======================
           Personnel section
      ======================== -->
      <section class="card" style="margin-top:24px;">
        <h3>Personnel</h3>
        {% if personnel and personnel|length > 0 %}
          <table class="budget-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Position</th>
                <th>Hours for year(s)</th>
                <th>Same Each Year?</th>
              </tr>
            </thead>
            <tbody>
            {% for p in personnel %}
              <tr>
                <td>{{ p.name or 'N/A' }}</td>
                <td>{{ p.position or 'N/A' }}</td>
                <td>
                  {% if p.hours %}
                    {% for h in p.hours %}
                      {{ h.year }}: {{ h.hours }} hrs{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if p.same_each_year is none %}
                    N/A
                  {% else %}
                    {{ 'Yes' if p.same_each_year else 'No' }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No personnel details recorded.</p>
        {% endif %}
      </section>

      <!-- =======================
           Travel section
      ======================== -->
      <section class="card" style="margin-top:24px;">
        <h3>Travel Information</h3>
        {% if (domestic_travel and domestic_travel|length > 0)
              or (international_travel and international_travel|length > 0) %}
          <table class="budget-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Description</th>
                <th>Total Estimated Amount</th>
              </tr>
            </thead>
            <tbody>
            {% for t in domestic_travel %}
              <tr>
                <td>Domestic</td>
                <td>{{ t.description or 'N/A' }}</td>
                <td>
                  {% if t.total_amount %}
                    ${{ '%.2f'|format(t.total_amount) }}
                  {% else %}
                    {# Fallback for old format - calculate total #}
                    {% set flight = t.flight or t.flight_cost or 0 %}
                    {% set taxi = t.taxi_per_day or 0 %}
                    {% set food = t.food_per_day or t.food_lodge_per_day or 0 %}
                    {% set days = t.days or t.num_days or 0 %}
                    {% set old_total = flight + (taxi + food) * days %}
                    ${{ '%.2f'|format(old_total) }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            {% for t in international_travel %}
              <tr>
                <td>International</td>
                <td>{{ t.description or 'N/A' }}</td>
                <td>
                  {% if t.total_amount %}
                    ${{ '%.2f'|format(t.total_amount) }}
                  {% else %}
                    {# Fallback for old format - calculate total #}
                    {% set flight = t.flight or t.flight_cost or 0 %}
                    {% set taxi = t.taxi_per_day or 0 %}
                    {% set food = t.food_per_day or t.food_lodge_per_day or 0 %}
                    {% set days = t.days or t.num_days or 0 %}
                    {% set old_total = flight + (taxi + food) * days %}
                    ${{ '%.2f'|format(old_total) }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No travel details recorded.</p>
        {% endif %}
      </section>

      <!-- =======================
           Materials / Supplies
      ======================== -->
      <section class="card" style="margin-top:24px;">
        <h3>Materials and Supplies</h3>
        {% if materials and materials|length > 0 %}
          <table class="budget-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody>
            {% for m in materials %}
              <tr>
                <td>{{ m.description or 'N/A' }}</td>
                <td>${{ '%.2f'|format(m.cost or 0) }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No materials/supplies recorded.</p>
        {% endif %}
      </section>



    </main>
  </div>
  <script src="{{ url_for('static', filename='theme.js') }}"></script>
  {% if user.role == 'Admin' and award.status == 'Pending' %}
  <script>
    document.getElementById('check-compliance-btn')?.addEventListener('click', function() {
      const btn = this;
      const textSpan = document.getElementById('check-compliance-text');
      const loadingSpan = document.getElementById('check-compliance-loading');
      const complianceSection = document.getElementById('compliance-section');
      
      // Show loading state
      textSpan.style.display = 'none';
      loadingSpan.style.display = 'inline';
      btn.disabled = true;
      btn.style.opacity = '0.6';
      
      // Make API call
      fetch(`/awards/{{ award.award_id }}/check-compliance`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show button again
        textSpan.style.display = 'inline';
        loadingSpan.style.display = 'none';
        btn.disabled = false;
        btn.style.opacity = '1';
        
        // Show compliance section
        if (complianceSection) {
          complianceSection.style.display = 'block';
          
          // Update the content
          let html = '<h3 style="margin-top:0;">AI Policy Compliance Check</h3>';
          
          if (data.error) {
            html += `<p style="color: #ef4444;">Error: ${data.error}</p>`;
          } else {
            html += '<div style="display: grid; gap: 16px;">';
            
            if (data.university) {
              const result = data.university.result;
              const color = result === 'compliant' ? '#10b981' : result === 'non-compliant' ? '#ef4444' : '#6b7280';
              const bgColor = result === 'compliant' ? '#f0fdf4' : result === 'non-compliant' ? '#fef2f2' : '#f9fafb';
              html += `
                <div style="padding: 12px; border-radius: 8px; border-left: 4px solid ${color}; background: ${bgColor};">
                  <strong>University Policy:</strong> 
                  <span style="text-transform: capitalize; font-weight: 600; color: ${color};">
                    ${result}
                  </span>
                  <p style="margin: 8px 0 0 0; color: #4b5563;">${data.university.reason}</p>
                </div>
              `;
            }
            
            if (data.federal) {
              const result = data.federal.result;
              const color = result === 'compliant' ? '#10b981' : result === 'non-compliant' ? '#ef4444' : '#6b7280';
              const bgColor = result === 'compliant' ? '#f0fdf4' : result === 'non-compliant' ? '#fef2f2' : '#f9fafb';
              html += `
                <div style="padding: 12px; border-radius: 8px; border-left: 4px solid ${color}; background: ${bgColor};">
                  <strong>Federal Policy:</strong> 
                  <span style="text-transform: capitalize; font-weight: 600; color: ${color};">
                    ${result}
                  </span>
                  <p style="margin: 8px 0 0 0; color: #4b5563;">${data.federal.reason}</p>
                </div>
              `;
            }
            
            if (data.sponsor) {
              const result = data.sponsor.result;
              const color = result === 'compliant' ? '#10b981' : result === 'non-compliant' ? '#ef4444' : '#6b7280';
              const bgColor = result === 'compliant' ? '#f0fdf4' : result === 'non-compliant' ? '#fef2f2' : '#f9fafb';
              html += `
                <div style="padding: 12px; border-radius: 8px; border-left: 4px solid ${color}; background: ${bgColor};">
                  <strong>Sponsor Policy:</strong> 
                  <span style="text-transform: capitalize; font-weight: 600; color: ${color};">
                    ${result}
                  </span>
                  <p style="margin: 8px 0 0 0; color: #4b5563;">${data.sponsor.reason}</p>
                </div>
              `;
            }
            
            html += '</div>';
          }
          
          complianceSection.innerHTML = html;
          
          // Scroll to compliance section
          complianceSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      })
      .catch(error => {
        console.error('Error checking compliance:', error);
        alert('Error checking compliance. Please try again.');
        
        // Reset button
        textSpan.style.display = 'inline';
        loadingSpan.style.display = 'none';
        btn.disabled = false;
        btn.style.opacity = '1';
      });
    });
  </script>
  {% endif %}
</body>
</html>
